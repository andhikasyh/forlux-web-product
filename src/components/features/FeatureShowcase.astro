---
import { currentLanguage } from '../../stores/languageStore';
import { translations } from '../../utils/translations';
import ModularAnimation from './animations/ModularAnimation';
import DetectionAnimation from './animations/DetectionAnimation';
import CommandAnimation from './animations/CommandAnimation';

// Initial language value for SSR
const initialLang = currentLanguage.get();

const features = [
  {
    id: "modular",
    icon: "ðŸ”„",
    gradient: "from-forlux-orange-primary to-forlux-orange-secondary",
    stats: [
      { id: "downtime", value: "0" },
      { id: "swap", value: "< 30s" }
    ],
    animation: "modular"
  },
  {
    id: "detection",
    icon: "ðŸ‘ï¸",
    gradient: "from-forlux-green-primary to-forlux-green-secondary",
    stats: [
      { id: "detection", value: "98%" },
      { id: "response", value: "< 3s" }
    ],
    animation: "detection"
  },
  {
    id: "command",
    icon: "ðŸŒ",
    gradient: "from-forlux-orange-secondary to-forlux-orange-accent",
    stats: [
      { id: "coverage", value: "100%" },
      { id: "updates", value: "Real-time" }
    ],
    animation: "command"
  }
];
---

<section class="relative py-32" id="feature-showcase">
  <div class="container mx-auto px-4">
    {features.map((feature, index) => (
      <div 
        class="mb-32 last:mb-0"
        data-aos="fade-up"
        data-aos-delay={index * 100}
      >
        <div class="glass-card p-8 relative overflow-hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
            <div class="space-y-6">
              <div class="flex items-center space-x-4">
                <span class="text-4xl">{feature.icon}</span>
                <h3 
                  class={`text-2xl font-bold bg-gradient-to-r ${feature.gradient} bg-clip-text text-transparent`}
                  id={`title-${feature.id}`}
                >
                  Loading...
                </h3>
              </div>
              
              <p 
                class="text-gray-400 leading-relaxed"
                id={`description-${feature.id}`}
              >
                Loading...
              </p>

              <div class="flex space-x-8">
                {feature.stats.map(stat => (
                  <div>
                    <div class={`text-2xl font-bold bg-gradient-to-r ${feature.gradient} bg-clip-text text-transparent`}>
                      {stat.value}
                    </div>
                    <div 
                      class="text-sm text-gray-400"
                      id={`stat-${feature.id}-${stat.id}`}
                    >
                      Loading...
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div class="relative h-[400px] bg-slate-900/50 rounded-lg overflow-hidden">
              {feature.animation === "modular" && (
                <ModularAnimation client:visible />
              )}
              {feature.animation === "detection" && (
                <DetectionAnimation client:visible />
              )}
              {feature.animation === "command" && (
                <CommandAnimation client:visible />
              )}
            </div>
          </div>
        </div>
      </div>
    ))}
  </div>
</section>

<script>
  import { currentLanguage } from '../../stores/languageStore';
  import { translations } from '../../utils/translations';

  function updateContent(lang) {
    const t = translations[lang].features.showcase;

    // Update modular feature
    document.getElementById('title-modular').textContent = t.modular.title;
    document.getElementById('description-modular').textContent = t.modular.description;
    document.getElementById('stat-modular-downtime').textContent = t.modular.stats.downtime;
    document.getElementById('stat-modular-swap').textContent = t.modular.stats.swap;

    // Update detection feature
    document.getElementById('title-detection').textContent = t.detection.title;
    document.getElementById('description-detection').textContent = t.detection.description;
    document.getElementById('stat-detection-detection').textContent = t.detection.stats.detection;
    document.getElementById('stat-detection-response').textContent = t.detection.stats.response;

    // Update command feature
    document.getElementById('title-command').textContent = t.command.title;
    document.getElementById('description-command').textContent = t.command.description;
    document.getElementById('stat-command-coverage').textContent = t.command.stats.coverage;
    document.getElementById('stat-command-updates').textContent = t.command.stats.updates;
  }

  function initFeatureShowcase() {
    // Initial render
    updateContent(currentLanguage.get());

    // Listen for language changes
    const unsubscribe = currentLanguage.subscribe(newLang => {
      updateContent(newLang);
    });

    // Cleanup subscription when component is destroyed
    return unsubscribe;
  }

  // Handle initial load and page transitions
  document.addEventListener('astro:page-load', () => {
    const unsubscribe = initFeatureShowcase();
    
    // Cleanup on page transition
    document.addEventListener('astro:before-preparation', () => {
      unsubscribe();
    }, { once: true });
  });
</script>